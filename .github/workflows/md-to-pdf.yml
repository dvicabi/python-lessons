name: MD ➜ PDF (Pixel-perfect GitHub style, Unicode, RTL, Images)

on:
  push:
    branches: [ main ]                 # שנה/י ל-master אם צריך
    paths:
      - '**.md'
      - '.github/workflows/md-to-pdf.yml'
  workflow_dispatch: {}

concurrency:
  group: md-to-pdf-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # 1) קח את קבצי הריפו
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2) התקן Node + פונטים מלאים (כולל עברית ואימוג'י)
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install system fonts (Hebrew + Emoji)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            fonts-noto \
            fonts-noto-extra \
            fonts-noto-color-emoji \
            fonts-dejavu \
            culmus \
            xvfb

      # 3) התקן תלות NPM לשכבת ה-HTML/CSS (md-to-pdf + CSS של GitHub + הדגשת סינטקס)
      - name: Install md-to-pdf toolchain
        run: |
          mkdir -p tools/mdpdf
          cd tools/mdpdf
          npm init -y
          npm install --save-exact md-to-pdf@5 github-markdown-css@5 highlight.js@11 markdown-it@14 markdown-it-footnote@4 markdown-it-emoji@3

      # 4) כתיבת קובץ ה-JS שממיר את כל ה-MD (כולל תיקון ESM/CJS לפלגינים + זיהוי RTL + הדגשת קוד)
      - name: Write convert.js
        run: |
          cat > tools/mdpdf/convert.js << 'EOF'
          const fs = require('fs');
          const path = require('path');
          const { mdToPdf } = require('md-to-pdf');

          const MarkdownIt = require('markdown-it');
          const hljs = require('highlight.js');

          // פלגינים (תמיכה גם ב-ESM וגם ב-CJS)
          const mdFootnoteMod = require('markdown-it-footnote');
          const mdEmojiMod = require('markdown-it-emoji');
          const asPlugin = (mod) => (typeof mod === 'function' ? mod : mod && mod.default ? mod.default : mod);

          const md = new MarkdownIt({
            html: true,
            linkify: true,
            typographer: true,
            highlight: (code, lang) => {
              try {
                if (lang && hljs.getLanguage(lang)) {
                  const out = hljs.highlight(code, { language: lang, ignoreIllegals: true }).value;
                  return `<pre><code class="hljs language-${lang}">${out}</code></pre>`;
                }
              } catch {}
              const esc = code
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
              return `<pre><code class="hljs">${esc}</code></pre>`;
            }
          })
            .use(asPlugin(mdFootnoteMod))
            .use(asPlugin(mdEmojiMod));

          // RTL detect: Hebrew block \u0590-\u05FF
          function isRTL(content) {
            return /[\u0590-\u05FF]/.test(content);
          }

          // עטיפת HTML בעיצוב GitHub + CSS מותאם + כיווניות
          function wrapHtml(bodyHtml, rtl) {
            const dirAttr = rtl ? 'dir="rtl"' : 'dir="ltr"';
            return `<!doctype html>
            <html ${dirAttr} lang="${rtl ? 'he' : 'en'}">
            <head>
              <meta charset="utf-8">
              <meta name="viewport" content="width=device-width, initial-scale=1">
              <link rel="stylesheet" href="node_modules/github-markdown-css/github-markdown.css">
              <link rel="stylesheet" href="mdpdf.css">
            </head>
            <body>
              <article class="markdown-body">
                ${bodyHtml}
              </article>
            </body>
            </html>`;
          }

          // איסוף כל קבצי ה-MD (דלג על תיקיות CI וכו')
          function collectMarkdownFiles(startDir) {
            const results = [];
            function walk(dir) {
              for (const entry of fs.readdirSync(dir, { withFileTypes: true })) {
                const full = path.join(dir, entry.name);
                if (entry.isDirectory()) {
                  const skip =
                    full.includes(path.sep + '.git' + path.sep) ||
                    full.includes(path.sep + '.github' + path.sep) ||
                    full.includes(path.sep + 'node_modules' + path.sep) ||
                    full.includes(path.sep + 'venv' + path.sep) ||
                    full.includes(path.sep + '.venv' + path.sep) ||
                    full.startsWith(path.resolve('tools/mdpdf'));
                  if (!skip) walk(full);
                } else if (entry.isFile() && entry.name.toLowerCase().endsWith('.md')) {
                  results.push(full);
                }
              }
            }
            walk(startDir);
            return results;
          }

          async function main() {
            const files = collectMarkdownFiles('.');
            console.log(`Found ${files.length} markdown files.`);
            let ok = 0, fail = 0;

            for (const file of files) {
              try {
                const mdContent = fs.readFileSync(file, 'utf8');
                const rtl = isRTL(mdContent);
                const html = md.render(mdContent);
                const wrapped = wrapHtml(html, rtl);

                const outPath = file.replace(/\.md$/i, '.pdf');
                fs.mkdirSync(path.dirname(outPath), { recursive: true });

                const result = await mdToPdf({ content: wrapped, basePath: path.dirname(file) }, {
                  pdf_options: {
                    format: 'A4',
                    printBackground: true,
                    margin: { top: '20mm', right: '20mm', bottom: '20mm', left: '20mm' }
                  },
                  launch_options: { args: ['--no-sandbox', '--disable-setuid-sandbox'] }
                });

                if (result?.pdf) {
                  fs.writeFileSync(outPath, result.pdf);
                  console.log(`OK  : ${file} -> ${outPath} ${rtl ? '[RTL]' : '[LTR]'}`);
                  ok++;
                } else {
                  console.warn(`FAIL: ${file} (no PDF)`);
                  fail++;
                }
              } catch (e) {
                console.warn(`FAIL: ${file} (${e.message})`);
                fail++;
              }
            }

            console.log('==== Summary ====');
            console.log('Converted OK:', ok);
            console.log('Failed      :', fail);
            if (ok === 0) process.exit(1);
          }

          main().catch(err => { console.error(err); process.exit(1); });
          EOF

      # 5) CSS אחיד לעיצוב GitHub + RTL + הדגשת סינטקס (inline, ללא CDN)
      - name: Write mdpdf.css
        run: |
          cat > tools/mdpdf/mdpdf.css << 'EOF'
          @page { size: A4; margin: 20mm; }

          body {
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
            font-family: "Noto Sans Hebrew", "Noto Sans", system-ui, Arial, sans-serif;
            line-height: 1.5;
          }

          .markdown-body { box-sizing: border-box; max-width: 100%; }

          /* RTL */
          html[dir="rtl"] .markdown-body { direction: rtl; text-align: right; }
          html[dir="rtl"] .markdown-body code,
          html[dir="rtl"] .markdown-body pre {
            direction: ltr; text-align: left;
            font-family: "DejaVu Sans Mono", "Noto Sans Mono", monospace;
          }

          /* תמונות */
          .markdown-body img { max-width: 100%; }

          /* טבלאות */
          .markdown-body table { border-collapse: collapse; width: 100%; }
          .markdown-body th, .markdown-body td { border: 1px solid #d0d7de; padding: 6px 10px; }
          .markdown-body th { background: #f6f8fa; }

          /* הדגשת קוד (theme בסיסי דמוי GitHub) */
          pre code.hljs { display: block; overflow-x: auto; padding: 1em; }
          code.hljs { padding: 0.2em 0.4em; }
          .hljs { background: #f6f8fa; color: #24292e; }
          .hljs-comment, .hljs-quote { color: #6a737d; font-style: italic; }
          .hljs-keyword, .hljs-selector-tag, .hljs-subst { color: #d73a49; }
          .hljs-literal, .hljs-number { color: #005cc5; }
          .hljs-string, .hljs-doctag, .hljs-regexp { color: #032f62; }
          .hljs-title, .hljs-section, .hljs-selector-id { color: #6f42c1; }
          .hljs-type, .hljs-class .hljs-title { color: #005cc5; }
          .hljs-attribute, .hljs-name, .hljs-variable { color: #e36209; }
          .hljs-template-variable, .hljs-bullet, .hljs-code, .hljs-addition { color: #22863a; }
          .hljs-selector-class, .hljs-symbol, .hljs-link, .hljs-deletion { color: #b31d28; }
          EOF

      # 6) הרצה: המרה של כל קבצי ה-MD בכל הריפו ל-PDF בעזרת Chromium
      - name: Convert all Markdown files to PDF (Chromium render)
        run: |
          cd tools/mdpdf
          npx --yes md-to-pdf --version
          node convert.js

      # 7) העלאה כ-Artifact (מבנה תיקיות נשמר)
      - name: Upload PDFs (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: md-pdfs
          path: '**/*.pdf'
          if-no-files-found: error
          retention-days: 14

      # 8) אופציונלי: לדחוף את ה-PDFים חזרה לריפו (לא יפעיל CI שוב)
      - name: Commit & push PDFs back to repo [optional]
        if: ${{ github.ref == 'refs/heads/main' && false }}   # החלף ל-true כדי להפעיל
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add -A '*.pdf'
          git commit -m "[skip ci][skip actions] Auto-generate PDFs from Markdown" || exit 0
          git push
